# GOOSE 运行规则（Windows / OpenRouter / Proxy）

## 核心必胜准则（5 条）
- 使用 OpenRouter 提供方：统一以 `provider=openrouter` 运行，并确保已设置 `OPENROUTER_API_KEY`（避免 401）。
- 限额控制以避免费用错误：默认将 `GOOSE_MAX_TOKENS=2000`（可按需临时提高，避免 402）。
- 代理稳定性：在 PowerShell 中设置并持久化 `HTTP_PROXY`、`HTTPS_PROXY`（如 `http://127.0.0.1:7897`），网络诊断用 `curl.exe -I https://openrouter.ai/api/v1/models`。
- 权限与配置写入：Roaming 配置不可写时，必须提醒以管理员权限覆盖（从 `%LOCALAPPDATA%\\Temp` 副本复制到 `%APPDATA%\\Block\\goose\\config\\config.yaml`）。
- 明确模型选择：模型需为 OpenRouter支持的有效名称（如 `google/gemini-2.0-flash-001` 或 `moonshotai/kimi-k2`），避免“Model Not Found”类误用。

## 推荐操作流程
- 会话前环境注入：
  - `$env:HTTP_PROXY='http://127.0.0.1:7897'; $env:HTTPS_PROXY='http://127.0.0.1:7897'`
  - `$env:OPENROUTER_API_KEY='<你的密钥>'`
  - `$env:GOOSE_MAX_TOKENS='2000'`
- 运行示例（OpenRouter + Gemini）：
  - `goose run --provider openrouter --model google/gemini-2.0-flash-001 -t "你好"`
- 若需修改配置文件：
  - 先生成临时文件 `%LOCALAPPDATA%\\Temp\\goose_config_openrouter.yaml`
  - 管理员终端中执行：
    - `Copy-Item -Path "$env:LOCALAPPDATA\\Temp\\goose_config_openrouter.yaml" -Destination "C:\\Users\\onroud\\AppData\\Roaming\\Block\\goose\\config\\config.yaml" -Force`

## GitHub 规则文本（可粘贴）
```
Title: Goose Runtime Rules (Windows/OpenRouter/Proxy)

Rules:
1) Provider: Always use openrouter with OPENROUTER_API_KEY set to a valid key
2) Token Budget: Default GOOSE_MAX_TOKENS=2000 to avoid 402 Payment Required
3) Proxy: Set HTTP_PROXY/HTTPS_PROXY (e.g. http://127.0.0.1:7897) before running
4) Permissions: If Roaming config write is denied, require Admin and copy from %LOCALAPPDATA%\\Temp
5) Models: Use valid OpenRouter model IDs (e.g. google/gemini-2.0-flash-001 or moonshotai/kimi-k2)

Checklist:
- [ ] OPENROUTER_API_KEY present and valid
- [ ] HTTP_PROXY/HTTPS_PROXY set and curl to /api/v1/models returns 200
- [ ] GOOSE_MAX_TOKENS=2000 unless explicitly increased
- [ ] Admin override for config writes when needed
- [ ] Model ID verified against OpenRouter catalog
```

## 经验与教训（规则化）
- 终端与命令：在 Windows 使用 PowerShell；不要使用 `&&` 作为分隔，使用分号或逐条执行。
- 代理与网络：先用 `curl.exe -I https://openrouter.ai/api/v1/models` 验证网络，再将 `HTTP_PROXY`/`HTTPS_PROXY` 持久化到 `$PROFILE`。
- 提供方与密钥：统一使用 `provider=openrouter`；清理旧的 ANTHROPIC 变量，确保仅存在有效 `OPENROUTER_API_KEY`。
- 额度控制：默认 `GOOSE_MAX_TOKENS=2000`；需要提高时先评估费用风险，避免触发 402。
- 配置写入权限：Roaming 路径不可写时，使用管理员权限从 `%LOCALAPPDATA%\\Temp` 复制覆盖到 `%APPDATA%\\Block\\goose\\config\\config.yaml`。
- 模型选择与回退：优先选用已验证的模型 ID（如 `google/gemini-2.0-flash-001`/`moonshotai/kimi-k2`）；异常时快速回退到稳定模型。
- Git 同步校验：推送前用 `git ls-files` 和本地读取文件前 10 行确认非空与正确内容。
- 提交规范：提交信息清晰表达变更意图；变更粒度适中，便于审计与回滚。
- 换行符：接受 Git 的 CRLF/LF 正常化提示，保持仓库内换行风格一致。
- 安全与密钥：不在仓库中提交任何密钥或敏感信息；仅在环境变量中注入。
- 安装策略：npm 安装失败或网络受限时，使用官方 Release 压缩包方式安装 goose。
